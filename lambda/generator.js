"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
// lambda/generator.ts
const client_bedrock_runtime_1 = require("@aws-sdk/client-bedrock-runtime");
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const uuid_1 = require("uuid");
// ----- config from env -----
const TABLE_NAME = process.env.ITEMS_TABLE_NAME;
const MODEL_ID = process.env.BEDROCK_MODEL_ID; // e.g. "anthropic.claude-3-sonnet-20240229-v1:0"
const REGION = process.env.AWS_REGION || "eu-west-1";
// ----- one-time clients -----
const bedrock = new client_bedrock_runtime_1.BedrockRuntimeClient({ region: REGION });
const ddb = new client_dynamodb_1.DynamoDBClient({ region: REGION });
// ----- schema (trimmed – keep keys in sync with your latest) -----
const INTERACTIVE_ITEM_SCHEMA = /* json */ `
You must return JSON that validates against this schema:
{
  "$schema":"https://json-schema.org/draft/2020-12/schema",
  "type":"object",
  "required":["id","version","type","lang","status","spec"],
  "properties":{
    "id":{"type":"string","pattern":"^item_[a-f0-9]{8}$"},
    "version":{"type":"integer"},
    "type":{"enum":["word_search","quiz_mcq","memory_match","space_shooter","jigsaw"]},
    "lang":{"type":"string"},
    "status":{"enum":["PENDING","APPROVED","REJECTED"]},
    "spec":{"type":"object"}
  }
}
`.trim();
// -- basic utility ----------------------------------------------------
function nowIso() { return new Date().toISOString(); }
// -- Lambda entry -----------------------------------------------------
const handler = async (event = {}) => {
    /* 1️⃣  Choose the item type & language from the request or default */
    const requestedType = event.type || "word_search";
    const requestedLang = event.lang || "en";
    /* 2️⃣  Craft a prompt */
    const prompt = `
You are an expert puzzle generator. Return ONLY JSON that validates against this schema:

${INTERACTIVE_ITEM_SCHEMA}

Prompt: Produce a new interactive item.
  type   = "${requestedType}",
  lang   = "${requestedLang}",
  theme  = "hackathon-demo",
  difficulty = "easy".

Return only JSON, without \`\`\` fences.
Return only JSON. Do not include explanations, markdown, or any text outside the JSON object.
If you do not know a field, fill it with a plausible placeholder.
`;
    /* 3️⃣  Bedrock Anthropic Claude 3.5/3 Sonnet message format */
    const anthropicPayload = {
        anthropic_version: "bedrock-2023-05-31",
        max_tokens: 1024,
        messages: [
            {
                role: "user",
                content: prompt
            }
        ]
    };
    const body = {
        modelId: MODEL_ID,
        contentType: "application/json",
        accept: "application/json",
        body: JSON.stringify(anthropicPayload)
    };
    /* 4️⃣  Call Bedrock */
    const response = await bedrock.send(new client_bedrock_runtime_1.InvokeModelCommand(body));
    const raw = new TextDecoder().decode(response.body);
    // Strip out any preamble if present (Claude sometimes returns extra text)
    const jsonStart = raw.indexOf('{');
    const jsonEnd = raw.lastIndexOf('}');
    let item;
    try {
        const outer = JSON.parse(raw);
        const jsonStr = outer?.content?.[0]?.text;
        item = JSON.parse(jsonStr);
    }
    catch (err) {
        console.error("Could not extract puzzle JSON from Claude response:", raw);
        return {
            statusCode: 500,
            body: JSON.stringify({ error: "Claude output not valid JSON", raw })
        };
    }
    console.log("RAW Bedrock output:", raw);
    console.log("PARSED Bedrock item:", item);
    /* 5️⃣  Post-process: add id, timestamps, status */
    const itemId = `item_${(0, uuid_1.v4)().replace(/-/g, "").slice(0, 8)}`;
    item.id = itemId;
    item.version = 1;
    item.status = "PENDING";
    item.createdAt = nowIso();
    /* 6️⃣  Store in DynamoDB */
    if (!item || !item.type || !item.lang || !item.spec) {
        console.error("Incomplete item from Bedrock:", item);
        return {
            statusCode: 500,
            body: JSON.stringify({ error: "Claude output incomplete", detail: item })
        };
    }
    await ddb.send(new client_dynamodb_1.PutItemCommand({
        TableName: TABLE_NAME,
        Item: {
            itemId: { S: item.id },
            version: { N: item.version.toString() },
            type: { S: item.type },
            status: { S: item.status },
            lang: { S: item.lang },
            createdAt: { S: item.createdAt },
            spec: { S: JSON.stringify(item.spec) }
        }
    }));
    /* 7️⃣  Return result to caller */
    return {
        statusCode: 200,
        headers: {
            "Access-Control-Allow-Origin": "*", // allow all domains
            "Access-Control-Allow-Headers": "*", // allow any headers
            "Access-Control-Allow-Methods": "OPTIONS,POST,GET" // allow these methods
        },
        body: JSON.stringify({ ok: true, itemId })
    };
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJhdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZ2VuZXJhdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLHNCQUFzQjtBQUN0Qiw0RUFBMkY7QUFDM0YsOERBQTBFO0FBQzFFLCtCQUFvQztBQUVwQyw4QkFBOEI7QUFDOUIsTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxnQkFBaUIsQ0FBQztBQUNqRCxNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGdCQUFpQixDQUFDLENBQUMsaURBQWlEO0FBQ2pHLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxJQUFJLFdBQVcsQ0FBQztBQUVyRCwrQkFBK0I7QUFDL0IsTUFBTSxPQUFPLEdBQUcsSUFBSSw2Q0FBb0IsQ0FBQyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDO0FBQzdELE1BQU0sR0FBRyxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDO0FBRW5ELG9FQUFvRTtBQUNwRSxNQUFNLHVCQUF1QixHQUFHLFVBQVUsQ0FBQzs7Ozs7Ozs7Ozs7Ozs7O0NBZTFDLENBQUMsSUFBSSxFQUFFLENBQUM7QUFFVCx3RUFBd0U7QUFDeEUsU0FBUyxNQUFNLEtBQUssT0FBTyxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUMsQ0FBQztBQUV0RCx3RUFBd0U7QUFDakUsTUFBTSxPQUFPLEdBQUcsS0FBSyxFQUFFLFFBQWEsRUFBRSxFQUFnQixFQUFFO0lBQzNELHNFQUFzRTtJQUN0RSxNQUFNLGFBQWEsR0FBRyxLQUFLLENBQUMsSUFBSSxJQUFJLGFBQWEsQ0FBQztJQUNsRCxNQUFNLGFBQWEsR0FBRyxLQUFLLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQztJQUV6Qyx5QkFBeUI7SUFDekIsTUFBTSxNQUFNLEdBQUc7OztFQUdqQix1QkFB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SSxDQUFDLElBQUksZ0NBQWMsQ0FBQztRQUM5QixTQUFTLEVBQUUsVUFBVTtRQUNyQixJQUFJLEVBQUU7WUFDRixNQUFNLEVBQUUsRUFBRSxDQUFDLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtZQUN0QixPQUFPLEVBQUUsRUFBRSxDQUFDLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsRUFBRTtZQUN2QyxJQUFJLEVBQUUsRUFBRSxDQUFDLEVBQUUsSUFBSSxDQUFDLElBQUksRUFBRTtZQUN0QixNQUFNLEVBQUUsRUFBRSxDQUFDLEVBQUUsSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUMxQixJQUFJLEVBQUUsRUFBRSxDQUFDLEVBQUUsSUFBSSxDQUFDLElBQUksRUFBRTtZQUN0QixTQUFTLEVBQUUsRUFBRSxDQUFDLEVBQUUsSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNoQyxJQUFJLEVBQUUsRUFBRSxDQUFDLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUU7U0FDekM7S0FDSixDQUFDLENBQUMsQ0FBQztJQUVKLGtDQUFrQztJQUNsQyxPQUFPO1FBQ0gsVUFBVSxFQUFFLEdBQUc7UUFDZixPQUFPLEVBQUU7WUFDTCw2QkFBNkIsRUFBRSxHQUFHLEVBQUksb0JBQW9CO1lBQzFELDhCQUE4QixFQUFFLEdBQUcsRUFBRyxvQkFBb0I7WUFDMUQsOEJBQThCLEVBQUUsa0JBQWtCLENBQUMsc0JBQXNCO1NBQzVFO1FBQ0QsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxFQUFFLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxDQUFDO0tBQzdDLENBQUM7QUFDTixDQUFDLENBQUM7QUExR1csUUFBQSxPQUFPLFdBMEdsQiIsInNvdXJjZXNDb250ZW50IjpbIi8vIGxhbWJkYS9nZW5lcmF0b3IudHNcbmltcG9ydCB7IEJlZHJvY2tSdW50aW1lQ2xpZW50LCBJbnZva2VNb2RlbENvbW1hbmQgfSBmcm9tIFwiQGF3cy1zZGsvY2xpZW50LWJlZHJvY2stcnVudGltZVwiO1xuaW1wb3J0IHsgRHluYW1vREJDbGllbnQsIFB1dEl0ZW1Db21tYW5kIH0gZnJvbSBcIkBhd3Mtc2RrL2NsaWVudC1keW5hbW9kYlwiO1xuaW1wb3J0IHsgdjQgYXMgdXVpZHY0IH0gZnJvbSBcInV1aWRcIjtcblxuLy8gLS0tLS0gY29uZmlnIGZyb20gZW52IC0tLS0tXG5jb25zdCBUQUJMRV9OQU1FID0gcHJvY2Vzcy5lbnYuSVRFTVNfVEFCTEVfTkFNRSE7XG5jb25zdCBNT0RFTF9JRCA9IHByb2Nlc3MuZW52LkJFRFJPQ0tfTU9ERUxfSUQhOyAvLyBlLmcuIFwiYW50aHJvcGljLmNsYXVkZS0zLXNvbm5ldC0yMDI0MDIyOS12MTowXCJcbmNvbnN0IFJFR0lPTiA9IHByb2Nlc3MuZW52LkFXU19SRUdJT04gfHwgXCJldS13ZXN0LTFcIjtcblxuLy8gLS0tLS0gb25lLXRpbWUgY2xpZW50cyAtLS0tLVxuY29uc3QgYmVkcm9jayA9IG5ldyBCZWRyb2NrUnVudGltZUNsaWVudCh7IHJlZ2lvbjogUkVHSU9OIH0pO1xuY29uc3QgZGRiID0gbmV3IER5bmFtb0RCQ2xpZW50KHsgcmVnaW9uOiBSRUdJT04gfSk7XG5cbi8vIC0tLS0tIHNjaGVtYSAodHJpbW1lZCDigJMga2VlcCBrZXlzIGluIHN5bmMgd2l0aCB5b3VyIGxhdGVzdCkgLS0tLS1cbmNvbnN0IElOVEVSQUNUSVZFX0lURU1fU0NIRU1BID0gLyoganNvbiAqLyBgXG5Zb3UgbXVzdCByZXR1cm4gSlNPTiB0aGF0IHZhbGlkYXRlcyBhZ2FpbnN0IHRoaXMgc2NoZW1hOlxue1xuICBcIiRzY2hlbWFcIjpcImh0dHBzOi8vanNvbi1zY2hlbWEub3JnL2RyYWZ0LzIwMjAtMTIvc2NoZW1hXCIsXG4gIFwidHlwZVwiOlwib2JqZWN0XCIsXG4gIFwicmVxdWlyZWRcIjpbXCJpZFwiLFwidmVyc2lvblwiLFwidHlwZVwiLFwibGFuZ1wiLFwic3RhdHVzXCIsXCJzcGVjXCJdLFxuICBcInByb3BlcnRpZXNcIjp7XG4gICAgXCJpZFwiOntcInR5cGVcIjpcInN0cmluZ1wiLFwicGF0dGVyblwiOlwiXml0ZW1fW2EtZjAtOV17OH0kXCJ9LFxuICAgIFwidmVyc2lvblwiOntcInR5cGVcIjpcImludGVnZXJcIn0sXG4gICAgXCJ0eXBlXCI6e1wiZW51bVwiOltcIndvcmRfc2VhcmNoXCIsXCJxdWl6X21jcVwiLFwibWVtb3J5X21hdGNoXCIsXCJzcGFjZV9zaG9vdGVyXCIsXCJqaWdzYXdcIl19LFxuICAgIFwibGFuZ1wiOntcInR5cGVcIjpcInN0cmluZ1wifSxcbiAgICBcInN0YXR1c1wiOntcImVudW1cIjpbXCJQRU5ESU5HXCIsXCJBUFBST1ZFRFwiLFwiUkVKRUNURURcIl19LFxuICAgIFwic3BlY1wiOntcInR5cGVcIjpcIm9iamVjdFwifVxuICB9XG59XG5gLnRyaW0oKTtcblxuLy8gLS0gYmFzaWMgdXRpbGl0eSAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5mdW5jdGlvbiBub3dJc28oKSB7IHJldHVybiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCk7IH1cblxuLy8gLS0gTGFtYmRhIGVudHJ5IC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5leHBvcnQgY29uc3QgaGFuZGxlciA9IGFzeW5jIChldmVudDogYW55ID0ge30pOiBQcm9taXNlPGFueT4gPT4ge1xuICAgIC8qIDHvuI/ig6MgIENob29zZSB0aGUgaXRlbSB0eXBlICYgbGFuZ3VhZ2UgZnJvbSB0aGUgcmVxdWVzdCBvciBkZWZhdWx0ICovXG4gICAgY29uc3QgcmVxdWVzdGVkVHlwZSA9IGV2ZW50LnR5cGUgfHwgXCJ3b3JkX3NlYXJjaFwiO1xuICAgIGNvbnN0IHJlcXVlc3RlZExhbmcgPSBldmVudC5sYW5nIHx8IFwiZW5cIjtcblxuICAgIC8qIDLvuI/ig6MgIENyYWZ0IGEgcHJvbXB0ICovXG4gICAgY29uc3QgcHJvbXB0ID0gYFxuWW91IGFyZSBhbiBleHBlcnQgcHV6emxlIGdlbmVyYXRvci4gUmV0dXJuIE9OTFkgSlNPTiB0aGF0IHZhbGlkYXRlcyBhZ2FpbnN0IHRoaXMgc2NoZW1hOlxuXG4ke0lOVEVSQUNUSVZFX0lURU1fU0NIRU1BfVxuXG5Qcm9tcHQ6IFByb2R1Y2UgYSBuZXcgaW50ZXJhY3RpdmUgaXRlbS5cbiAgdHlwZSAgID0gXCIke3JlcXVlc3RlZFR5cGV9XCIsXG4gIGxhbmcgICA9IFwiJHtyZXF1ZXN0ZWRMYW5nfVwiLFxuICB0aGVtZSAgPSBcImhhY2thdGhvbi1kZW1vXCIsXG4gIGRpZmZpY3VsdHkgPSBcImVhc3lcIi5cblxuUmV0dXJuIG9ubHkgSlNPTiwgd2l0aG91dCBcXGBcXGBcXGAgZmVuY2VzLlxuUmV0dXJuIG9ubHkgSlNPTi4gRG8gbm90IGluY2x1ZGUgZXhwbGFuYXRpb25zLCBtYXJrZG93biwgb3IgYW55IHRleHQgb3V0c2lkZSB0aGUgSlNPTiBvYmplY3QuXG5JZiB5b3UgZG8gbm90IGtub3cgYSBmaWVsZCwgZmlsbCBpdCB3aXRoIGEgcGxhdXNpYmxlIHBsYWNlaG9sZGVyLlxuYDtcblxuICAgIC8qIDPvuI/ig6MgIEJlZHJvY2sgQW50aHJvcGljIENsYXVkZSAzLjUvMyBTb25uZXQgbWVzc2FnZSBmb3JtYXQgKi9cbiAgICBjb25zdCBhbnRocm9waWNQYXlsb2FkID0ge1xuICAgICAgICBhbnRocm9waWNfdmVyc2lvbjogXCJiZWRyb2NrLTIwMjMtMDUtMzFcIixcbiAgICAgICAgbWF4X3Rva2VuczogMTAyNCxcbiAgICAgICAgbWVzc2FnZXM6IFtcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICByb2xlOiBcInVzZXJcIixcbiAgICAgICAgICAgICAgICBjb250ZW50OiBwcm9tcHRcbiAgICAgICAgICAgIH1cbiAgICAgICAgXVxuICAgIH07XG5cbiAgICBjb25zdCBib2R5ID0ge1xuICAgICAgICBtb2RlbElkOiBNT0RFTF9JRCxcbiAgICAgICAgY29udGVudFR5cGU6IFwiYXBwbGljYXRpb24vanNvblwiLFxuICAgICAgICBhY2NlcHQ6IFwiYXBwbGljYXRpb24vanNvblwiLFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeShhbnRocm9waWNQYXlsb2FkKVxuICAgIH07XG5cbiAgICAvKiA077iP4oOjICBDYWxsIEJlZHJvY2sgKi9cbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGJlZHJvY2suc2VuZChuZXcgSW52b2tlTW9kZWxDb21tYW5kKGJvZHkpKTtcbiAgICBjb25zdCByYXcgPSBuZXcgVGV4dERlY29kZXIoKS5kZWNvZGUocmVzcG9uc2UuYm9keSk7XG5cblxuXG4gICAgLy8gU3RyaXAgb3V0IGFueSBwcmVhbWJsZSBpZiBwcmVzZW50IChDbGF1ZGUgc29tZXRpbWVzIHJldHVybnMgZXh0cmEgdGV4dClcbiAgICBjb25zdCBqc29uU3RhcnQgPSByYXcuaW5kZXhPZigneycpO1xuICAgIGNvbnN0IGpzb25FbmQgPSByYXcubGFzdEluZGV4T2YoJ30nKTtcbiAgICBsZXQgaXRlbTtcbiAgICB0cnkge1xuICAgICAgICBjb25zdCBvdXRlciA9IEpTT04ucGFyc2UocmF3KTtcbiAgICAgICAgY29uc3QganNvblN0ciA9IG91dGVyPy5jb250ZW50Py5bMF0/LnRleHQ7XG4gICAgICAgIGl0ZW0gPSBKU09OLnBhcnNlKGpzb25TdHIpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBjb25zb2xlLmVycm9yKFwiQ291bGQgbm90IGV4dHJhY3QgcHV6emxlIEpTT04gZnJvbSBDbGF1ZGUgcmVzcG9uc2U6XCIsIHJhdyk7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBzdGF0dXNDb2RlOiA1MDAsXG4gICAgICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVycm9yOiBcIkNsYXVkZSBvdXRwdXQgbm90IHZhbGlkIEpTT05cIiwgcmF3IH0pXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgY29uc29sZS5sb2coXCJSQVcgQmVkcm9jayBvdXRwdXQ6XCIsIHJhdyk7XG4gICAgY29uc29sZS5sb2coXCJQQVJTRUQgQmVkcm9jayBpdGVtOlwiLCBpdGVtKTtcblxuICAgIC8qIDXvuI/ig6MgIFBvc3QtcHJvY2VzczogYWRkIGlkLCB0aW1lc3RhbXBzLCBzdGF0dXMgKi9cbiAgICBjb25zdCBpdGVtSWQgPSBgaXRlbV8ke3V1aWR2NCgpLnJlcGxhY2UoLy0vZywgXCJcIikuc2xpY2UoMCwgOCl9YDtcbiAgICBpdGVtLmlkID0gaXRlbUlkO1xuICAgIGl0ZW0udmVyc2lvbiA9IDE7XG4gICAgaXRlbS5zdGF0dXMgPSBcIlBFTkRJTkdcIjtcbiAgICBpdGVtLmNyZWF0ZWRBdCA9IG5vd0lzbygpO1xuXG4gICAgLyogNu+4j+KDoyAgU3RvcmUgaW4gRHluYW1vREIgKi9cbiAgICBpZiAoIWl0ZW0gfHwgIWl0ZW0udHlwZSB8fCAhaXRlbS5sYW5nIHx8ICFpdGVtLnNwZWMpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihcIkluY29tcGxldGUgaXRlbSBmcm9tIEJlZHJvY2s6XCIsIGl0ZW0pO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgc3RhdHVzQ29kZTogNTAwLFxuICAgICAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogXCJDbGF1ZGUgb3V0cHV0IGluY29tcGxldGVcIiwgZGV0YWlsOiBpdGVtIH0pXG4gICAgICAgIH07XG4gICAgfVxuXG5cbiAgICBhd2FpdCBkZGIuc2VuZChuZXcgUHV0SXRlbUNvbW1hbmQoe1xuICAgICAgICBUYWJsZU5hbWU6IFRBQkxFX05BTUUsXG4gICAgICAgIEl0ZW06IHtcbiAgICAgICAgICAgIGl0ZW1JZDogeyBTOiBpdGVtLmlkIH0sXG4gICAgICAgICAgICB2ZXJzaW9uOiB7IE46IGl0ZW0udmVyc2lvbi50b1N0cmluZygpIH0sXG4gICAgICAgICAgICB0eXBlOiB7IFM6IGl0ZW0udHlwZSB9LFxuICAgICAgICAgICAgc3RhdHVzOiB7IFM6IGl0ZW0uc3RhdHVzIH0sXG4gICAgICAgICAgICBsYW5nOiB7IFM6IGl0ZW0ubGFuZyB9LFxuICAgICAgICAgICAgY3JlYXRlZEF0OiB7IFM6IGl0ZW0uY3JlYXRlZEF0IH0sXG4gICAgICAgICAgICBzcGVjOiB7IFM6IEpTT04uc3RyaW5naWZ5KGl0ZW0uc3BlYykgfVxuICAgICAgICB9XG4gICAgfSkpO1xuXG4gICAgLyogN++4j+KDoyAgUmV0dXJuIHJlc3VsdCB0byBjYWxsZXIgKi9cbiAgICByZXR1cm4ge1xuICAgICAgICBzdGF0dXNDb2RlOiAyMDAsXG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAgIFwiQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luXCI6IFwiKlwiLCAgIC8vIGFsbG93IGFsbCBkb21haW5zXG4gICAgICAgICAgICBcIkFjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnNcIjogXCIqXCIsICAvLyBhbGxvdyBhbnkgaGVhZGVyc1xuICAgICAgICAgICAgXCJBY2Nlc3MtQ29udHJvbC1BbGxvdy1NZXRob2RzXCI6IFwiT1BUSU9OUyxQT1NULEdFVFwiIC8vIGFsbG93IHRoZXNlIG1ldGhvZHNcbiAgICAgICAgfSxcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBvazogdHJ1ZSwgaXRlbUlkIH0pXG4gICAgfTtcbn07XG4iXX0=